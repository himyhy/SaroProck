---
// src/components/layout/Footer.astro
export interface Props {
  author: string;
  twitterHandle: string;
  githubUrl: string;
  telegramUrl: string;
}

const { author, twitterHandle, githubUrl, telegramUrl } = Astro.props;

const CACHE_DURATION = 3600 * 1000;
let cachedData: { stars: number; timestamp: number } | null = null;

async function getRepoStars(): Promise<number | null> {
  if (cachedData && Date.now() - cachedData.timestamp < CACHE_DURATION) {
    return cachedData.stars;
  }
  try {
    const owner = "himyhy";
    const repo = "SaroProck";
    const token = import.meta.env.GITHUB_TOKEN;
    const response = await fetch(
      `https://api.github.com/repos/${owner}/${repo}`,
      {
        headers: {
          Authorization: `token ${token}`,
        },
      },
    );
    if (!response.ok)
      throw new Error(`GitHub API request failed: ${response.status}`);
    const data = await response.json();
    const stars = data.stargazers_count;
    cachedData = { stars, timestamp: Date.now() };
    return stars;
  } catch (error) {
    console.error("Failed to fetch GitHub stars:", error);
    return null;
  }
}

function formatStars(num: number | null): string {
  if (num === null) return "";
  if (num >= 1000) return `${(num / 1000).toFixed(1)}k`;
  return String(num);
}

const starCount = await getRepoStars();
const formattedStars = formatStars(starCount);

// 定义链接，方便管理
const navLinks = [
  { href: "/", text: "动态" },
  { href: "/rss.xml", text: "博客" },
  { href: "/random", text: "漂流" },
  { href: "https://github.com/himyhy/SaroProck", text: "仓库" },
];

const socialLinks = [
  {
    href: `https://x.com/${twitterHandle.replace("@", "")}`,
    text: "Twitter / X",
    icon: "ri-twitter-x-line",
  },
  { href: githubUrl, text: "GitHub", icon: "ri-github-line" },
  { href: telegramUrl, text: "Telegram", icon: "ri-telegram-line" },
  { href: "/rss.xml", text: "RSS", icon: "ri-rss-line" },
];
---

<footer class="bg-base-200/50 backdrop-blur-sm text-base-content no-print border-t border-base-content/5">
  <div class="max-w-6xl mx-auto px-6">
    <div class="grid grid-cols-1 md:grid-cols-12 gap-10 py-12 md:py-16">
      <!-- Brand Section -->
      <div class="md:col-span-12 lg:col-span-5 space-y-6">
        <div>
          <a href="/" class="inline-flex items-center space-x-3 group">
            <div class="w-10 h-10 bg-gradient-to-br from-primary to-secondary rounded-2xl flex items-center justify-center shadow-lg shadow-primary/20 transition-transform group-hover:scale-110">
              <i class="ri-leaf-line text-primary-content text-xl"></i>
            </div>
            <span class="text-2xl font-black tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-base-content to-base-content/70">HY博客</span>
          </a>
        </div>
        
        <div class="space-y-2 max-w-md">
          <p class="text-sm font-medium text-base-content/80 leading-relaxed">
            一个孤独的地方，散落着一个人的人生碎片。
          </p>
          <p class="text-xs text-base-content/60 leading-relaxed">
            感谢你的漂流至此，希望这里的文字能为你带来片刻的宁静或思考。
          </p>
        </div>

        <div class="flex items-center gap-4">
          <a
            href="https://github.com/himyhy/SaroProck"
            target="_blank"
            rel="noopener noreferrer"
            class="btn btn-sm btn-ghost bg-base-300/50 hover:bg-primary hover:text-primary-content border-none rounded-xl transition-all duration-300 group"
          >
            <i class="ri-heart-3-line group-hover:animate-pulse"></i>
            <span>喜欢本站</span>
            {formattedStars && <span class="opacity-60 ml-1">· {formattedStars}</span>}
          </a>
        </div>
      </div>

      <!-- Links Sections -->
      <div class="grid grid-cols-2 md:grid-cols-3 lg:col-span-4 gap-8">
        <div class="space-y-4">
          <h6 class="text-xs font-bold uppercase tracking-widest text-base-content/40">探索</h6>
          <ul class="space-y-3">
            {navLinks.map((link) => (
              <li>
                <a href={link.href} class="text-sm text-base-content/70 hover:text-primary hover:translate-x-1 inline-block transition-all duration-200">
                  {link.text}
                </a>
              </li>
            ))}
          </ul>
        </div>

        <div class="space-y-4">
          <h6 class="text-xs font-bold uppercase tracking-widest text-base-content/40">关注</h6>
          <ul class="space-y-3">
            {socialLinks.map((link) => (
              <li>
                <a href={link.href} target="_blank" rel="noopener noreferrer" class="flex items-center gap-2 text-sm text-base-content/70 hover:text-primary hover:translate-x-1 transition-all duration-200">
                  <i class={`${link.icon} text-lg opacity-50`} />
                  <span>{link.text}</span>
                </a>
              </li>
            ))}
          </ul>
        </div>
      </div>

      <!-- QR Code Section -->
      <div class="lg:col-span-3 flex flex-col items-center lg:items-end justify-start">
        <div class="p-3 bg-base-100 rounded-2xl shadow-xl shadow-base-content/5 border border-base-content/5 rotate-2 hover:rotate-0 transition-transform duration-500">
          <figure class="w-32 h-32 overflow-hidden rounded-lg bg-white p-1">
            <img src="/qrcode.png" alt="二维码" class="w-full h-full object-contain" />
          </figure>
          <p class="text-[10px] text-center mt-2 font-bold text-base-content/30 uppercase tracking-tighter">Scan to connect</p>
        </div>
      </div>
    </div>

    <!-- Bottom Bar -->
    <div class="py-8 border-t border-base-content/5 flex flex-col md:flex-row justify-between items-center gap-4 text-[11px] font-medium text-base-content/40 uppercase tracking-widest">
      <div>
        © {new Date().getFullYear()} {author} · Personal Digital Garden
      </div>
      <div class="flex items-center gap-4">
        <span>Powered by Astro</span>
        <span class="w-1 h-1 rounded-full bg-base-content/20"></span>
        <a href="https://github.com/himyhy/SaroProck" class="hover:text-primary transition-colors" target="_blank">Original Theme</a>
      </div>
    </div>
  </div>
</footer>
