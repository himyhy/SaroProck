---
import { type CollectionEntry, getCollection } from "astro:content";
import TOC from "@components/blog/TOC.astro";
import type { MarkdownHeading } from "astro";

export interface Props {
  author: string;
  twitterHandle: string;
  githubUrl: string;
  telegramUrl: string;
  headings?: MarkdownHeading[];
  idPrefix?: string;
}

const {
  headings,
  author,
  twitterHandle,
  githubUrl,
  telegramUrl,
  idPrefix: _idPrefix = "sidebar",
} = Astro.props;

// 动态统计数据 (无改动)
const allPosts = await getCollection(
  "blog",
  ({ data }: CollectionEntry<"blog">) => data.draft !== true,
);
const countWords = (text: string) => {
  text = text.replace(/[\u3000-\u303F\uFF00-\uFFEF]/g, "");
  text = text.replace(/[`*~_#+\-![\]{}()>|]/g, "");
  const cjkChars = text.match(/[\u4e00-\u9fa5]/g)?.length || 0;
  const otherWords =
    text.replace(/[\u4e00-\u9fa5]/g, " ").match(/\b\w+\b/g)?.length || 0;
  return cjkChars + otherWords;
};
const totalWords = allPosts.reduce(
  (acc: number, post: CollectionEntry<"blog">) => acc + countWords(post.body),
  0,
);
const formattedTotalWords =
  totalWords > 1000 ? `${(totalWords / 1000).toFixed(1)}k` : totalWords;
const stats = {
  articles: allPosts.length,
  words: formattedTotalWords,
};

const QQ_GROUP_NUMBER = "2484913990";
const EMAIL_ADDRESS = "myhywo@gmail.com";
---

<aside class="lg:col-span-1 no-print">
  <div class="lg:sticky lg:top-20 space-y-4">
    <div
      class="bg-base-200/40 backdrop-blur-sm rounded-xl p-4 border border-base-content/5 space-y-4"
    >
      <div>
        <div class="flex items-center space-x-3 mb-3">
          <div class="avatar">
            <div
              class="w-10 h-10 rounded-full ring-1 ring-primary/20 ring-offset-1 ring-offset-base-100"
            >
              <img src="/avatar.webp" alt="Avatar" />
            </div>
          </div>
          <div>
            <h3 class="font-semibold text-sm">{author}</h3>
            <p class="font-semibold text-base-content/70 text-xs">Developer</p>
          </div>
        </div>
        <p class="text-base-content/70 text-xs mb-3 leading-relaxed">
          热爱技术，喜欢记录生活中的点点滴滴。
        </p>
        <div class="flex items-center gap-x-1">
          <a
            href={`https://twitter.com/${twitterHandle.replace("@", "")}`}
            target="_blank"
            rel="noopener noreferrer"
            class="btn btn-ghost btn-sm btn-circle"
            aria-label="访问我的 Twitter"
          >
            <i class="ri-twitter-line text-lg"></i>
          </a>
          <a
            href={githubUrl}
            target="_blank"
            rel="noopener noreferrer"
            class="btn btn-ghost btn-sm btn-circle"
            aria-label="访问我的 GitHub"
          >
            <i class="ri-github-line text-lg"></i>
          </a>
          <a
            href={telegramUrl}
            target="_blank"
            rel="noopener noreferrer"
            class="btn btn-ghost btn-sm btn-circle"
            aria-label="访问我的 Telegram"
          >
            <i class="ri-telegram-line text-lg"></i>
          </a>
        </div>
      </div>

      <div class="divider my-2"></div>

      <div>
        <h4 class="text-xs font-semibold uppercase text-base-content/70 mb-2">
          我的频道
        </h4>
        <a
          href="https://t.me/hy_post"
          target="_blank"
          rel="noopener noreferrer"
          class="flex items-center justify-between bg-base-100 rounded-lg p-3 border border-base-content/10 transition hover:border-primary/60 hover:bg-base-100/80"
        >
          <span class="flex items-center gap-2 text-sm">
            <i class="ri-telegram-fill text-base-content/70"></i>
            <span class="font-mono text-base-content/80">t.me/hy_post</span>
          </span>
          <i class="ri-external-link-line text-base-content/60" aria-hidden="true"></i>
        </a>
      </div>
    </div>

    {
      headings && headings.length > 0 ? (
        <TOC headings={headings} />
      ) : (
        <>
          <div class="bg-base-200/40 backdrop-blur-sm rounded-xl p-5 border border-base-content/5">
            <h3 class="font-semibold text-base mb-4 flex items-center">
              <i class="ri-article-line text-primary mr-2" />
              最新文章
            </h3>
            <div class="space-y-3">
              {allPosts.slice(0, 5).map((post: CollectionEntry<"blog">) => (
                <a
                  href={`/blog/${post.slug}`}
                  class="block p-3 rounded-lg bg-base-100 border border-base-content/10 hover:border-primary/60 hover:bg-base-100/80 transition group"
                >
                  <h4 class="text-sm font-semibold line-clamp-2 group-hover:text-primary transition">
                    {post.data.title}
                  </h4>
                  <time class="text-xs text-base-content/50 mt-1 block">
                    {post.data.pubDate.toLocaleDateString("zh-CN", {
                      year: "numeric",
                      month: "short",
                      day: "numeric",
                    })}
                  </time>
                </a>
              ))}
            </div>
            <a
              href="/blog"
              class="btn btn-ghost btn-sm w-full mt-4 justify-start"
            >
              <i class="ri-arrow-right-line" />
              查看全部文章
            </a>
          </div>

          <div class="bg-base-200/40 backdrop-blur-sm rounded-xl p-5 border border-base-content/5">
            <h3 class="font-semibold text-base mb-5 flex items-center">
              <i class="ri-bar-chart-fill text-primary mr-2" />
              站点统计
            </h3>
            <div class="space-y-5">
              <div class="flex items-center gap-4">
                <div class="w-12 text-center">
                  <i class="ri-article-line text-4xl text-primary/70" />
                </div>
                <div>
                  <p class="text-2xl font-semibold leading-tight">
                    {stats.articles}
                  </p>
                  <p class="text-sm text-base-content/70">篇文章</p>
                </div>
              </div>
              <div class="flex items-center gap-4">
                <div class="w-12 text-center">
                  <i class="ri-file-word-2-line text-4xl text-primary/70" />
                </div>
                <div>
                  <p class="text-2xl font-semibold leading-tight">
                    {stats.words}
                  </p>
                  <p class="text-sm text-base-content/70">总字数</p>
                </div>
              </div>
            </div>
          </div>
          <div class="bg-base-200/40 backdrop-blur-sm rounded-xl p-4 border border-base-content/5">
            <h3 class="font-semibold text-base mb-5 flex items-center">
              <i class="ri-contacts-book-line text-primary mr-2" />
              联系方式
            </h3>
            <div class="space-y-2">
              <div class="flex items-center justify-between bg-base-100 rounded-lg p-3 border border-base-content/10 transition hover:border-primary/60 hover:bg-base-100/80">
                <span class="flex items-center gap-2 text-sm">
                  <i class="ri-mail-line" /> 邮箱
                </span>
                <span class="font-mono text-xs text-base-content/80">
                  {EMAIL_ADDRESS}
                </span>
              </div>
              <a
                href={`mailto:${EMAIL_ADDRESS}`}
                class="btn w-full bg-base-100 rounded-lg p-3 border border-base-content/10 hover:bg-primary hover:text-primary-content transition-all"
              >
                <i class="ri-mail-send-line" />
                发送邮件
              </a>
            </div>
          </div>
        </>
      )
    }

    {
      !headings && (
        <div class="bg-base-200/40 backdrop-blur-sm rounded-xl p-5 border border-base-content/5">
          <h3 class="font-semibold text-base mb-4 flex items-center">
            <i class="ri-article-line text-primary mr-2" />
            最新文章
          </h3>
          <div class="space-y-3">
            {allPosts.slice(0, 5).map((post: CollectionEntry<"blog">) => (
              <a
                href={`/blog/${post.slug}`}
                class="block p-3 rounded-lg bg-base-100 border border-base-content/10 hover:border-primary/60 hover:bg-base-100/80 transition group"
              >
                <h4 class="text-sm font-semibold line-clamp-2 group-hover:text-primary transition">
                  {post.data.title}
                </h4>
                <time class="text-xs text-base-content/50 mt-1 block">
                  {post.data.pubDate.toLocaleDateString("zh-CN", {
                    year: "numeric",
                    month: "short",
                    day: "numeric",
                  })}
                </time>
              </a>
            ))}
          </div>
          <a
            href="/blog"
            class="btn btn-ghost btn-sm w-full mt-4 justify-start"
          >
            <i class="ri-arrow-right-line" />
            查看全部文章
          </a>
        </div>
      )
    }
  </div>
</aside>
