<button
  type="button"
  class="btn btn-ghost btn-circle"
  aria-label="切换主题"
  data-theme-toggle
>
  <i class="ri-moon-line text-lg" data-theme-icon="moon"></i>
  <i class="ri-sun-line text-lg hidden" data-theme-icon="sun"></i>
</button>

<script is:inline>
  (() => {
    const getPreferredTheme = () => {
      try {
        const savedTheme = localStorage.getItem("theme");
        if (savedTheme === "light" || savedTheme === "dark") {
          return savedTheme;
        }
      } catch {
        // ignore
      }

      return window.matchMedia("(prefers-color-scheme: dark)").matches
        ? "dark"
        : "light";
    };

    const getAppliedTheme = () => {
      const html = document.documentElement;
      return html.getAttribute("data-theme") === "dark" ||
        html.classList.contains("dark")
        ? "dark"
        : "light";
    };

    const applyTheme = (theme) => {
      const html = document.documentElement;
      if (theme === "dark") {
        html.setAttribute("data-theme", "dark");
        html.classList.add("dark");
        html.style.colorScheme = "dark";
      } else {
        html.setAttribute("data-theme", "light");
        html.classList.remove("dark");
        html.style.colorScheme = "light";
      }

      try {
        localStorage.setItem("theme", theme);
      } catch {
        // ignore
      }
    };

    const syncButtonState = (button, theme) => {
      const moon = button.querySelector('[data-theme-icon="moon"]');
      const sun = button.querySelector('[data-theme-icon="sun"]');
      if (!(moon instanceof HTMLElement) || !(sun instanceof HTMLElement)) return;

      moon.classList.toggle("hidden", theme !== "light");
      sun.classList.toggle("hidden", theme !== "dark");
      button.title = theme === "light" ? "切换到夜间模式" : "切换到日间模式";
    };

    const bindToggle = (button) => {
      if (!(button instanceof HTMLButtonElement) || button.dataset.themeToggleBound === "1") {
        return;
      }

      button.dataset.themeToggleBound = "1";
      syncButtonState(button, getAppliedTheme());

      button.addEventListener("click", () => {
        const current = getAppliedTheme();
        const next = current === "light" ? "dark" : "light";
        applyTheme(next);
        document
          .querySelectorAll("button[data-theme-toggle]")
          .forEach((el) => syncButtonState(el, next));
      });
    };

    const init = () => {
      const preferred = getPreferredTheme();
      applyTheme(preferred);
      document
        .querySelectorAll("button[data-theme-toggle]")
        .forEach((el) => bindToggle(el));
    };

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", init, { once: true });
    } else {
      init();
    }

    document.addEventListener("astro:page-load", init);
  })();
</script>
