<button
  type="button"
  class="btn btn-ghost btn-circle"
  aria-label="切换主题"
  data-theme-toggle
>
  <i class="ri-moon-line text-lg" data-theme-icon="moon"></i>
  <i class="ri-sun-line text-lg hidden" data-theme-icon="sun"></i>
</button>

<script is:inline>
  (() => {
    const getFallbackTheme = () => {
      const html = document.documentElement;
      return html.getAttribute("data-theme") === "dark" ||
        html.classList.contains("dark")
        ? "dark"
        : "light";
    };

    const getThemeApi = () => {
      const globalApi = window.__themeApi;
      if (
        globalApi &&
        typeof globalApi.getTheme === "function" &&
        typeof globalApi.setTheme === "function"
      ) {
        return globalApi;
      }

      return {
        getTheme: getFallbackTheme,
        setTheme: (theme) => {
          const html = document.documentElement;
          if (theme === "dark") {
            html.setAttribute("data-theme", "dark");
            html.classList.add("dark");
            html.style.colorScheme = "dark";
          } else {
            html.setAttribute("data-theme", "light");
            html.classList.remove("dark");
            html.style.colorScheme = "light";
          }
          return theme === "dark" ? "dark" : "light";
        },
      };
    };

    const syncButtonState = (button, theme) => {
      const moon = button.querySelector('[data-theme-icon="moon"]');
      const sun = button.querySelector('[data-theme-icon="sun"]');
      if (!(moon instanceof HTMLElement) || !(sun instanceof HTMLElement)) return;

      moon.classList.toggle("hidden", theme !== "light");
      sun.classList.toggle("hidden", theme !== "dark");
      button.title = theme === "light" ? "切换到夜间模式" : "切换到日间模式";
    };

    const syncAllButtons = () => {
      const api = getThemeApi();
      const currentTheme = api.getTheme();
      document
        .querySelectorAll("button[data-theme-toggle]")
        .forEach((el) => syncButtonState(el, currentTheme));
    };

    const bindToggle = (button) => {
      if (!(button instanceof HTMLButtonElement) || button.dataset.themeToggleBound === "1") {
        return;
      }

      button.dataset.themeToggleBound = "1";
      syncButtonState(button, getThemeApi().getTheme());

      button.addEventListener("click", () => {
        const api = getThemeApi();
        const current = api.getTheme();
        const next = current === "light" ? "dark" : "light";
        api.setTheme(next);
        syncAllButtons();
      });
    };

    const init = () => {
      syncAllButtons();
      document
        .querySelectorAll("button[data-theme-toggle]")
        .forEach((el) => bindToggle(el));
    };

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", init, { once: true });
    } else {
      init();
    }

    document.addEventListener("astro:page-load", init);
  })();
</script>
